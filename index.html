<html>
<head>
  <title>Select Your Stats!</title>
  <meta charset="utf-8" />
  <script src="d3.min.js"></script>
  <script src="queue.js"></script>
  <link rel="stylesheet" href="style.css" />
</head>


<body>
  <div id="viz">
  </div>

<script>

d3.select("div#viz").append("svg")

queue()
  .defer(d3.json, "classes.json")
  .defer(d3.csv, "relations.csv")
  .await(function(error, classes, relations) { dataViz(classes.all, relations) });


function dataViz(classes, relations) {

  // determine where to place each class
  setPositions(classes)

  // var vizG = d3.select("svg")
  //              .append("g")
  //              .attr("id", "vizG")
  //              .attr("transform", "translate(0, 0)");

  // create a g element for each class
  var allG = d3.select("svg")
               .selectAll("g")
               .data(classes, function(d) { return d.class })
               .enter()
               .append("g")
               .attr("transform", function(d) {
                                   return "translate(" + d.x + "," + d.y + ")"
                                 })

  // hash class nodes
  var nodeHash = {}
  hashClasses()

  // determine where to place labels beside circles
  labelsExtent = d3.extent(classes, function(d) { return d.abbrev.length })
  labelsScale = d3.scale.linear().domain(labelsExtent).range([-38, -65])

  // create a circle for each class
  var circles = allG.append("circle")
                    .attr("r", function(d) {
                      if (d.category != "Math") {
                        return 22
                      } else {
                        return 14
                      }
                    })
                    .attr("cx", 0)
                    .attr("cy", 0)
                    .style("fill", function(d) {
                      if (d.category == "Math") {
                        return "#7DCEA0"
                      } else if (d.category == "Elective") {
                        return "#D6EAF8"
                      } else if (d.category == "Consulting") {
                        return "#EB984E"
                      } else {
                        return "#7FB3D5"
                      }
                    })
                    .on("mouseover", mouseoverClasses)
                    .on("mouseout", mouseoutClasses)

  // create a label for each class
  var labels = allG.append("text")
                  .attr("x", function(d) { return labelsScale(d.abbrev.length) })
                  .attr("y", 0)
                  .text(function(d) { return d.abbrev })

  // implement: determine where to place each class
  function setPositions(nodes) {
    for (i in nodes) {
        if (nodes[i].category == "Math") {
          nodes[i].x = 200
          nodes[i].y = 100 + i * 40
        } else if (nodes[i].category == "Lower") {
          nodes[i].x = 350
          nodes[i].y = 100 + (i-6) * 75
        } else if (nodes[i].category == "100") {
          nodes[i].x = 500
          nodes[i].y = 100 + (i-8) * 75
        } else if (nodes[i].category == "101") {
          nodes[i].x = 650
          nodes[i].y = 100 + (i-11) * 75
        } else if (nodes[i].category == "102") {
          nodes[i].x = 800
          nodes[i].y = 100 + (i-14) * 75
        } else if (nodes[i].category == "Elective") {
          nodes[i].x = 300 + (i-17) * 100
          nodes[i].y = 400
        } else if (nodes[i].category == "Consulting") {
          nodes[i].x = 300 + (i-22) * 100
          nodes[i].y = 500
        }
      }
  }

  // implement: hash class nodes
  function hashClasses() {
    for (i in classes) {
      nodeHash[classes[i].class] = classes[i]
    }
    for (i in relations) {
      if (relations[i].requirement == "Enforced") {
        relations[i].weight = 2.5
      } else if (relations[i].requirement == "Choice") {
        relations[i].weight = 1.5
      } else {
        relations[i].weight = 1
      }
      relations[i].source = nodeHash[relations[i].source]
      relations[i].target = nodeHash[relations[i].target]
    }
  }

  // implement: create animation when mouse is over a class
  function mouseoverClasses(d, i) {
    var links = getRelations(d, i)
    var selectSelf = allG.filter(function(p) { return p.class == d.class })
    var newSelection = allG.filter(function(p) {
                                      var linksCount = links.length
                                      if (linksCount == 0) {
                                        return p.class != d.class
                                      } else if (linksCount == 1) {
                                        return p.class != d.class &&
                                               p.class != links[0].source.class
                                      } else if (linksCount == 2) {
                                        return p.class != d.class &&
                                               p.class != links[0].source.class &&
                                               p.class != links[1].source.class
                                      } else if (linksCount == 3) {
                                        return p.class != d.class &&
                                               p.class != links[0].source.class &&
                                               p.class != links[1].source.class &&
                                               p.class != links[2].source.class
                                      } else if (linksCount > 3) {
                                        console.log("More than 3 prereqs!")
                                      }
                                  })

    newSelection.selectAll("circle")
                .transition()
                .duration(300)
                .style("opacity", 0)
    selectSelf.select("circle")
              .transition()
              .duration(100)
              .style("stroke", "black")
              .style("stroke-width", "4px")

    newSelection.selectAll("text")
                .transition()
                .duration(200)
                .style("opacity", 0)

    // revealRelations(d, i, links)
  }

  // implement: create animation when mouse is out of a class
  function mouseoutClasses(d, i) {
    console.log("Mouse out!")
    allG.selectAll("circle")
        .transition()
        .duration(300)
        .style("opacity", 1)

    allG.selectAll("text")
        .transition()
        .duration(300)
        .style("opacity", 1)

    hideRelations()
  }

  // implement: get prereqs of a class
  function getRelations(d, i) {
    var links = []
    var linksCount = 0
    for (i in relations) {
      if (nodeHash[d.class] == relations[i].target) {
        links[linksCount] = relations[i]
        linksCount++
      }
    }
    return links
  }

  // implement: create lines connecting prereqs and a mouse-overed class
  function revealRelations(d, i, links) {
    d3.select("svg").selectAll("line")
        .data(links)
        .enter()
        .append("line")
        .attr("x1", function(p) { return p.source.x })
        .attr("y1", function(p) { return p.source.y })
        .attr("x2", function(p) { return p.target.x })
        .attr("y2", function(p) { return p.target.y })
        .attr("class", "links")
        .style("stroke", function(p) {
                           if (p.requirement == "Enforced") {
                             return "blue"
                           } else if (p.requirement == "Choice") {
                             return "orange"
                           } else {
                             return "seagreen"
                           }
                         })
        .style("stroke-width", function(p) { return p.weight })
    }

  function hideRelations() {
    console.log("Implement hideRelations() !")
  }


}

</script>
</body>

</html>
